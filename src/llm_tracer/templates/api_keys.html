{% extends "base_dashboard.html" %}

{% block title %}API Keys - LLM Tracer{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-2xl font-bold text-slate-900">API Keys</h1>
        <p class="text-slate-600 mt-1">Manage your API keys for SDK authentication</p>
    </div>
    <button onclick="showCreateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition inline-flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        New API Key
    </button>
</div>

<!-- Info Box -->
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <div class="flex gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div class="text-sm text-blue-800">
            <p class="font-medium">Keep your API keys safe</p>
            <p class="mt-1">API keys are shown only once when created. Store them securely and never share them publicly.</p>
        </div>
    </div>
</div>

<!-- API Keys Table -->
<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Key</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Last Used</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Created</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider"></th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-slate-200">
            {% for key in api_keys %}
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm font-medium text-slate-900">{{ key.name }}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <code class="text-sm text-slate-600 bg-slate-100 px-2 py-1 rounded">{{ key.key|truncate(20) }}...</code>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    {% if key.is_active %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                        Active
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                        Revoked
                    </span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm text-slate-500">{{ (key.last_used_at|strftime('%b %d, %H:%M') if key.last_used_at else '-') }}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm text-slate-500">{{ key.created_at|strftime('%b %d, %Y') }}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    {% if key.is_active %}
                    <button onclick="revokeKey({{ key.id }})" class="text-red-600 hover:text-red-700 text-sm font-medium">
                        Revoke
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="px-6 py-12 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-slate-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                    <p class="text-lg font-medium text-slate-500">No API keys yet</p>
                    <p class="text-sm text-slate-400 mt-1">Create an API key to start using the SDK</p>
                    <button onclick="showCreateModal()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                        Create API Key
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Create Modal -->
<div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
        <h2 class="text-xl font-bold text-slate-900 mb-4">Create API Key</h2>
        <form id="createForm" onsubmit="createKey(event)">
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">Name</label>
                <input type="text" name="name" required placeholder="e.g., Production Key" class="w-full rounded-lg border border-slate-300 px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 mb-1">Project</label>
                <select name="project_id" required class="w-full rounded-lg border border-slate-300 px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select a project</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
                {% if not projects %}
                <p class="text-sm text-amber-600 mt-2">
                    <a href="/projects" class="underline">Create a project first</a> before generating an API key.
                </p>
                {% endif %}
            </div>
            <div class="flex gap-3 justify-end">
                <button type="button" onclick="hideCreateModal()" class="px-4 py-2 text-sm font-medium text-slate-700 hover:text-slate-900">Cancel</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Key Created Modal -->
<div id="keyCreatedModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 p-6">
        <div class="text-center mb-4">
            <div class="bg-emerald-100 text-emerald-600 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h2 class="text-xl font-bold text-slate-900">API Key Created!</h2>
        </div>
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-amber-800">
                <strong>Important:</strong> Copy this key now. You won't be able to see it again!
            </p>
        </div>
        <div class="bg-slate-100 rounded-lg p-4 mb-6 font-mono text-sm break-all" id="newKeyValue"></div>
        <div class="flex gap-3 justify-end">
            <button onclick="copyKey()" class="px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700">Copy</button>
            <button onclick="closeKeyModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">Done</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let newApiKey = '';
    
    function showCreateModal() {
        document.getElementById('createModal').classList.remove('hidden');
    }
    
    function hideCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
    }
    
    async function createKey(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            name: form.name.value,
            project_id: parseInt(form.project_id.value)
        };
        
        const response = await fetch('/api/v1/api-keys', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            newApiKey = result.key;
            hideCreateModal();
            document.getElementById('newKeyValue').textContent = newApiKey;
            document.getElementById('keyCreatedModal').classList.remove('hidden');
        } else {
            alert('Failed to create API key');
        }
    }
    
    function copyKey() {
        navigator.clipboard.writeText(newApiKey);
        alert('API key copied to clipboard!');
    }
    
    function closeKeyModal() {
        document.getElementById('keyCreatedModal').classList.add('hidden');
        window.location.reload();
    }
    
    async function revokeKey(id) {
        if (!confirm('Are you sure you want to revoke this API key? This cannot be undone.')) return;
        
        const response = await fetch(`/api/v1/api-keys/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to revoke API key');
        }
    }
</script>
{% endblock %}
